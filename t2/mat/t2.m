% T2
format long 

% Units for the values: V, mA, kOhm, mS and uF
% Values:  
R1 = 1.04001336091 
R2 = 2.04372276851 
R3 = 3.11359737601 
R4 = 4.17085404861 
R5 = 3.02859283303 
R6 = 2.070545767 
R7 = 1.01835949725 
Vs = 5.20102702949 
C = 1.00460501759 
Kb = 7.19043597753 
Kd = 8.06397385506 


%-------------------------------------------------------------------------------
% 1) Nodal analysis (t<0)
%-------------------------------------------------------------------------------
      
     % V1, V2, V3, V5, V6, V7, V8
A1 = [1,0,0,0,0,0,0; ... % ---------------------------------------node 1

      0,-(1/R1)-(1/R2)-(1/R3),(1/R2),(1/R3),0,0,0; ... % ---------node 2
      
      0,Kb+(1/R2),-(1/R2),-Kb,0,0,0; ...  % ----------------------node 3 
      
      0,-Kb,0,(1/R5)+Kb,-(1/R5),0,0; ... % -----------------------node 6
      
      0,0,0,0,0,-(1/R6)-(1/R7),(1/R7); ... % ---------------------node 7
      
      0,(1/R3),0,-(1/R3)-(1/R4)-(1/R5),(1/R5),(1/R7),-(1/R7); ... %supernode 5,8
      
      0,0,0,1,0,(Kd/R6),-1] % ------------------------------------additional equation: dependent voltage source
      
     
B1 = [Vs;-(Vs/R1);0;0;0;0;0]

C1 = A1\B1



%-------------------------------------------------------------------------------
% 2) Nodal analysis (Vs = 0; Vx = V6-V8)
%-------------------------------------------------------------------------------

Vs = 0
V6 = C1(5,1)
V8 = C1(7,1)
Vx = V6-V8

    % V1, V2, V3, V5, V6, V7, V8, Ix
A2 = [1,0,0,0,0,0,0,0; ... %---------------------------------------node 1

     0,-(1/R1)-(1/R2)-(1/R3),(1/R2),(1/R3),0,0,0,0; ... % ---------node 2
     
     0,Kb+(1/R2),-(1/R2),-Kb,0,0,0,0; ...  % ----------------------node 3 
     
     0,-Kb,0,(1/R5)+Kb,-(1/R5),0,0,-1; ... % ----------------------node 6
     
     0,0,0,0,0,-(1/R6)-(1/R7),(1/R7),0; ... % ---------------------node 7
     
     0,(1/R3),0,-(1/R3)-(1/R4)-(1/R5),(1/R5),(1/R7),-(1/R7),1; ... %supernode 5,8
     
     0,0,0,1,0,(Kd/R6),-1,0; ... % --------------------------------additional equation: dependent voltage source
     
     0,0,0,0,1,0,-1,0] % ------------------------------------------additional equation: Vx = V6-V8
     
     
B2 = [Vs;-(Vs/R1);0;0;0;0;0;Vx]
     
C2 = A2\B2

Ix = C2(8,1)

Req = (Vx/Ix) % Equivalent resistance

tau = (Req*10^3)*(C*10^-6) % Time constant


%-------------------------------------------------------------------------------
% 3) Natural solution, v_6n(t)
%-------------------------------------------------------------------------------

t=0:0.000001:0.020;

v_6n = Vx*exp(-(t/abs(tau)));

figure();
plot(t*10^3, v_6n, "r")
xlabel ("time [ms]");
ylabel ("v_6_n [V]");
grid on;
legend("v_6_n(t)");


%-------------------------------------------------------------------------------
% 4) Forced solution, v_6f(t)
%-------------------------------------------------------------------------------

f = 1000 % Hz
w= 2*pi*f
Zc = 1/(j*w*C*(10^-6))
Vs = j

     % V1, V2, V3, V5, V6, V7, V8
A4 = [1,0,0,0,0,0,0; ... % ----------------------------------------------------node 1

      0,-(1/R1)-(1/R2)-(1/R3),(1/R2),(1/R3),0,0,0; ... % ----------------------node 2
      
      0,Kb+(1/R2),-(1/R2),-Kb,0,0,0; ...  % -----------------------------------node 3 
      
      0,-Kb,0,(1/R5)+Kb,-(1/R5)-(1/Zc),0,(1/Zc); ... % ------------------------node 6
      
      0,0,0,0,0,-(1/R6)-(1/R7),(1/R7); ... % ----------------------------------node 7
      
      0,(1/R3),0,-(1/R3)-(1/R4)-(1/R5),(1/Zc)+(1/R5),(1/R7),-(1/R7)-(1/Zc); ...%supernode 5,8
      
      0,0,0,1,0,(Kd/R6),-1] % -------------------------------------------------additional equation: dependent voltage source
      
     
B4 = [Vs;-(Vs/R1);0;0;0;0;0]

C4 = A4\B4

mag_v6 = abs(C4(5,1))
ph_v6 = angle(C4(5,1))

t=0:0.000001:0.020;

v_6f = mag_v6*cos(w*t-ph_v6);

figure();
plot(t*10^3, v_6f, 'b')
xlabel ("time [ms]");
ylabel ("v_6_f [V]");
grid on;
legend("v_6_f(t)");


%-------------------------------------------------------------------------------
% 5) Total solution, v_6(t)
%-------------------------------------------------------------------------------

t=0:0.000001:0.020;

v_6 = v_6n + v_6f;

figure();
plot(t*1000, v_6)
xlabel ("time [ms]");
ylabel ("v_6 [V]");
grid on;
legend("v_6(t)");